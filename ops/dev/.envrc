#!/usr/bin/env bash

#########################################################################
#
#                 -- Generated with omgcmd --
#      (do not edit unless you know what you're doing)
#
#########################################################################

# Copyright (C) 2022 One More Game - All Rights Reserved
# Unauthorized copying of this file, via any medium is strictly prohibited
# Proprietary and confidential

# shellcheck disable=SC2059
# shellcheck disable=SC1090
# shellcheck disable=SC1091

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
WORKSPACE="$(realpath "$SCRIPT_DIR/../..")"

readonly ENV="dev"
readonly INFRA_ENV="dev"
readonly ENV_DIR="${SCRIPT_DIR}/env"
readonly ENV_PATH="${ENV_DIR}/.env"
readonly VSCODE_ENV_PATH="${ENV_DIR}/.vscode.env"
readonly TF_DIR="${WORKSPACE}/terraform/environments/$ENV"

export OMG_ENV="unset"
export RUN_MODE="per_env"

mkdir -p "$ENV_DIR"

source_up

source "$WORKSPACE/bin/lib"

if "$WORKSPACE/bin/login" "$ENV" "$INFRA_ENV" "$ENV_PATH" "$TF_DIR"; then
  source "$ENV_PATH"
  source "$GENERATED_ENV_FILE"
elif [[ $? == 2 ]]; then
  source "$ENV_PATH"
  exit 0
else
  printf "\n\n${RED}Environment $ENV setup failed${NC}\n\n\n"
  exit 1
fi

# generate a .env file compatible with vscode launch environments
sed 's/export //' "$ENV_PATH" > "$VSCODE_ENV_PATH"

sleep 1s

printf "\n\n${GREEN}===== Environment configured sucessfully =====${NC}\n"
printf "${LIGHT_BLUE}Boundary:${NC} ${BOUNDARY_ADDR}\n"
printf "${LIGHT_BLUE}Consul:${NC} https://consul.${ENV_DOMAIN}\n"
printf "${LIGHT_BLUE}Fabio:${NC} https://fabio.${ENV_DOMAIN}\n"
printf "${LIGHT_BLUE}Vault:${NC} ${VAULT_ADDR}\n\n"

printf "Run ${YELLOW}\"proxy -c\"${NC} to open connections to service proxies.\n"
printf "${LIGHT_BLUE}Consul (proxied):${NC} ${CONSUL_HTTP_ADDR}\n"
printf "${LIGHT_BLUE}Nomad (proxied):${NC} ${NOMAD_ADDR}\n\n"

printf "${YELLOW} ** NOTE: Automatic installation of client certificates for proxied services is only tested in the Chrome web browser **${NC}\n\n\n"

export OMG_ENV=$ENV
